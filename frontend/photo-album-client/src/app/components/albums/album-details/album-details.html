<button type="button" (click)="goBack()">
  ← Back to Albums
</button>

<p *ngIf="errorMessage" class="error">
  {{ errorMessage }}
</p>

<!-- If we have an album, show everything -->
<div *ngIf="album as a">
  <h2>{{ a.title }}</h2>

  <p *ngIf="a.description">
    {{ a.description }}
  </p>

  <p>Album ID: {{ a._id }}</p>
  <p>Events: {{ a.events.length }}</p>

  <hr />

  <!-- Events list -->
  <div *ngIf="a.events && a.events.length > 0; else noEvents">
    <h3>Events</h3>
    <ul>
      <li *ngFor="let ev of a.events; trackBy: trackEvent">
        <!-- Display mode -->
        <ng-container *ngIf="editingEventId !== ev.eventId; else editEventBlock">
          <strong>{{ ev.name }}</strong>
          <span *ngIf="ev.startDate">
            — {{ ev.startDate }}
          </span>
          <span *ngIf="ev.location">
            — {{ ev.location }}
          </span>

          <button type="button" (click)="startEditEvent(ev)">
            Edit
          </button>
          <button type="button" (click)="deleteEvent(ev)">
            Delete
          </button>
        </ng-container>

        <!-- Edit mode -->
        <ng-template #editEventBlock>
          <form (ngSubmit)="saveEventChanges()">
            <div>
              <label for="editName">Name</label>
              <input
                id="editName"
                name="editName"
                type="text"
                [(ngModel)]="editEventName"
                required
              />
            </div>

            <div>
              <label for="editDate">Date</label>
              <input
                id="editDate"
                name="editDate"
                type="date"
                [(ngModel)]="editEventDate"
              />
            </div>

            <div>
              <label for="editLocation">Location</label>
              <input
                id="editLocation"
                name="editLocation"
                type="text"
                [(ngModel)]="editEventLocation"
              />
            </div>

            <p *ngIf="formError" class="error">
              {{ formError }}
            </p>

            <button type="submit">
              Save
            </button>
            <button type="button" (click)="cancelEditEvent()">
              Cancel
            </button>
          </form>
        </ng-template>

        <!-- Photos for this event -->
        <div
          *ngIf="getPhotosForEvent(ev.eventId).length > 0"
          class="event-photos"
        >
          <h4>Photos for this event</h4>
          <div class="photo-grid">
            <figure *ngFor="let p of getPhotosForEvent(ev.eventId)">
              <img
                [src]="imageBaseUrl + p.originalUrl"
                [alt]="ev.name || a.title"
                class="photo-thumb"
              />
              <figcaption *ngIf="p.uploadedAt">
                {{ p.uploadedAt | date: 'short' }}
              </figcaption>
            </figure>
          </div>
        </div>
      </li>
    </ul>
  </div>

  <ng-template #noEvents>
    <p>No events yet. Add the first one below.</p>
  </ng-template>

  <hr />

  <!-- Add new event form -->
  <h3>Add a new event</h3>
  <form (ngSubmit)="addEvent()">
    <div>
      <label for="newName">Name</label>
      <input
        id="newName"
        name="newName"
        type="text"
        [(ngModel)]="newEventName"
        required
      />
    </div>

    <div>
      <label for="newDate">Date</label>
      <input
        id="newDate"
        name="newDate"
        type="date"
        [(ngModel)]="newEventDate"
      />
    </div>

    <div>
      <label for="newLocation">Location</label>
      <input
        id="newLocation"
        name="newLocation"
        type="text"
        [(ngModel)]="newEventLocation"
      />
    </div>

    <p *ngIf="formError" class="error">
      {{ formError }}
    </p>

    <button type="submit">
      Add event
    </button>
  </form>

  <hr />

  <!-- Photos section -->
  <section class="photos">
    <h3>Photos</h3>

    <p *ngIf="photoError" class="error">
      {{ photoError }}
    </p>

    <div *ngIf="isLoadingPhotos">
      Loading photos...
    </div>

    <!-- No photos at all -->
    <div *ngIf="!isLoadingPhotos && photos.length === 0">
      No photos yet for this album.
    </div>

    <!-- Unassigned photos (no eventId) -->
    <div
      *ngIf="!isLoadingPhotos && unassignedPhotos.length > 0"
      class="unassigned-photos"
    >
      <h4>Photos not attached to an event</h4>
      <div class="photo-grid">
        <figure *ngFor="let p of unassignedPhotos">
          <img
            [src]="imageBaseUrl + p.originalUrl"
            [alt]="a.title"
            class="photo-thumb"
          />
          <figcaption *ngIf="p.uploadedAt">
            {{ p.uploadedAt | date: 'short' }}
          </figcaption>
        </figure>
      </div>
    </div>

    <!-- Upload form -->
    <form (ngSubmit)="onUploadPhotos($event)" class="photo-upload-form">
      <div>
        <label for="photoEvent">
          Attach to event (optional)
        </label>
        <select
          id="photoEvent"
          name="photoEvent"
          [(ngModel)]="selectedEventId"
        >
          <option value="">
            (No specific event)
          </option>
          <option
            *ngFor="let ev of a.events"
            [value]="ev.eventId"
          >
            {{ ev.name }}
          </option>
        </select>
      </div>

      <div>
        <label for="photoFiles">
          Add photos
        </label>
        <input
          id="photoFiles"
          type="file"
          multiple
          (change)="onFilesSelected($event)"
        />
      </div>

      <button
        type="submit"
        [disabled]="isUploading || !selectedFiles"
      >
        {{ isUploading ? 'Uploading…' : 'Upload' }}
      </button>
    </form>
  </section>
</div>

<!-- If no album yet and no error, show loading -->
<div *ngIf="!album && !errorMessage">
  Loading album details...
</div>
