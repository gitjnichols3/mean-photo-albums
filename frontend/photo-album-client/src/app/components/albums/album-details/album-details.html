<button type="button" (click)="goBack()" class="btn-back">
  ← Back to Albums
</button>

<p *ngIf="errorMessage" class="error">
  {{ errorMessage }}
</p>

<!-- Main album content -->
<div *ngIf="album as a" class="album-details">
  <header class="album-header">
    <h2 class="album-title">{{ a.title }}</h2>
    <p *ngIf="a.description" class="album-description">
      {{ a.description }}
    </p>
  </header>

  <div class="album-layout">
    <!-- TIMELINE COLUMN -->
    <section class="timeline">
      <h3 class="section-heading">Event Timeline</h3>

      <div *ngIf="timelineGroups.length === 0" class="empty-state">
        No events yet. Add your first event below.
      </div>

      <ng-container *ngFor="let group of timelineGroups">
        <h4 class="timeline-date">
          <span class="timeline-date-dot"></span>
          {{ group.dateLabel }}
        </h4>

        <ul class="timeline-list">
          <li
            *ngFor="let ev of group.events; trackBy: trackEvent"
            [class.selected]="ev.eventId === selectedEventId"
            class="timeline-event"
          >
            <div class="timeline-event-main">
              <button
                type="button"
                class="timeline-event-name-btn"
                (click)="selectEventForViewing(ev)"
              >
                <span class="timeline-event-name">
                  {{ ev.name || 'Untitled event' }}
                </span>
              </button>

              <button
                type="button"
                class="btn-link pill-action"
                (click)="editEvent(ev)"
              >
                Edit
              </button>

              <button
                type="button"
                class="btn-link pill-action"
                (click)="deleteEvent(ev)"
              >
                Delete
              </button>
            </div>
          </li>
        </ul>
      </ng-container>

      <button
        type="button"
        class="btn-secondary btn-small mt-1"
        (click)="clearEventSelection()"
      >
        View unassigned photos
      </button>
    </section>

    <!-- PHOTO COLUMN -->
    <section class="photo-panel">
      <h3 class="section-heading">
        Photos: {{ selectedEventId ? selectedEventName : 'Unassigned photos' }}
      </h3>

      <p *ngIf="photoError" class="error">
        {{ photoError }}
      </p>

      <div *ngIf="isLoadingPhotos" class="loading">
        Loading photos...
      </div>

      <div *ngIf="!isLoadingPhotos">
        <div
          *ngIf="selectedEventId && selectedEventPhotos.length === 0"
          class="empty-state"
        >
          No photos for this event yet.
        </div>

        <div
          *ngIf="!selectedEventId && unassignedPhotos.length === 0"
          class="empty-state"
        >
          No unassigned photos.
        </div>

        <div
          class="photo-grid"
          *ngIf="
            (selectedEventId && selectedEventPhotos.length > 0) ||
            (!selectedEventId && unassignedPhotos.length > 0)
          "
        >
          <figure
            *ngFor="
              let p of selectedEventId ? selectedEventPhotos : unassignedPhotos;
              let i = index
            "
            class="photo-card"
          >
            <img
              [src]="imageBaseUrl + p.originalUrl"
              [alt]="selectedEventId ? selectedEventName : a.title"
              class="photo-thumb"
              (click)="openPhotoViewer(i)"
            />

          <div class="photo-meta-row">
  <div class="photo-meta-main">
    <button
      type="button"
      class="btn-link btn-delete"
      (click)="deletePhoto(p)"
    >
      Delete
    </button>

    <select
      class="photo-event-select"
      [ngModel]="p.eventId || ''"
      (ngModelChange)="onChangePhotoEvent(p, $event)"
    >
      <option value="">
        Unassigned
      </option>

      <option
        *ngFor="let ev of album.events"
        [value]="ev.eventId"
      >
        {{ ev.name || 'Untitled event' }}
      </option>
    </select>
  </div>

  <figcaption
    *ngIf="p.takenAt || p.uploadedAt"
    class="photo-caption"
  >
    <ng-container *ngIf="p.takenAt; else uploadedDate">
      {{ p.takenAt | date: 'short' }}
    </ng-container>
    <ng-template #uploadedDate>
      Uploaded at: {{ p.uploadedAt | date: 'short' }}
    </ng-template>
  </figcaption>
</div>


          </figure>
        </div>
      </div>

      <!-- Upload form (column 2, under thumbnails) -->
      <form (ngSubmit)="onUploadPhotos($event)" class="photo-upload-form">
        <p class="hint">
          Uploads are attached to the currently selected event.
          If no event is selected, photos will be unassigned.
        </p>

        <div class="form-row">
          <label for="photoFiles" class="form-label">Add photos</label>
          <input
            id="photoFiles"
            type="file"
            multiple
            (change)="onFilesSelected($event)"
          />
        </div>

        <button
          type="submit"
          class="btn-primary"
          [disabled]="isUploading || !selectedFiles"
        >
          {{ isUploading ? 'Uploading…' : 'Upload' }}
        </button>
      </form>
    </section>
  </div>

  <hr class="divider" />

  <!-- ADD EVENT FORM -->
  <section class="add-event-panel">
    <h3 class="section-heading">
      Add a new event
    </h3>

    <form (ngSubmit)="addEvent()" #eventForm="ngForm" class="event-form">
      <div class="form-row">
        <label for="newName" class="form-label">Name</label>
        <input
          id="newName"
          name="newName"
          type="text"
          [(ngModel)]="newEventName"
          required
        />
      </div>

      <div class="form-row">
        <label for="newDate" class="form-label">Date</label>
        <input
          id="newDate"
          name="newDate"
          type="date"
          [(ngModel)]="newEventDate"
        />
      </div>

      <div class="form-row">
        <label for="newLocation" class="form-label">Location</label>
        <input
          id="newLocation"
          name="newLocation"
          type="text"
          [(ngModel)]="newEventLocation"
        />
      </div>

      <p *ngIf="formError" class="error">
        {{ formError }}
      </p>

      <button
        type="submit"
        class="btn-primary"
        [disabled]="eventForm.invalid"
      >
        Add event
      </button>
    </form>
  </section>

  <hr class="divider" />

  <!-- SHARE LINK SECTION -->
  <section class="share-panel">
    <h3 class="section-heading">
      Share this album
    </h3>

    <p class="hint">
      Create a special share link that shows a read-only view of this album
      and its photos.
    </p>

    <p *ngIf="shareError" class="error">
      {{ shareError }}
    </p>

    <!-- If we already have a share URL, show it as a clickable link + copy button -->
    <ng-container *ngIf="shareUrl; else createShare">
      <div class="share-link-box">
        <label class="form-label">
          Public share link
        </label>

        <div class="share-row">
          <!-- Clickable link, full URL visible -->
          <a
            [href]="shareUrl"
            target="_blank"
            rel="noopener"
            class="share-link-text"
          >
            {{ shareUrl }}
          </a>

          <button
            type="button"
            class="btn-secondary"
            (click)="copyShareUrl()"
          >
            {{
              copyStatus === 'copied'
                ? 'Copied!'
                : (copyStatus === 'error' ? 'Copy error' : 'Copy link')
            }}
          </button>
        </div>

        <p class="hint">
          Anyone with this link can view the album in read-only mode.
        </p>

        <p *ngIf="copyStatus === 'error'" class="error small">
          Could not copy automatically. You can still select and copy the link above.
        </p>
      </div>
    </ng-container>

    <!-- If no share URL yet, show the create button -->
    <ng-template #createShare>
      <div class="share-controls">
        <button
          type="button"
          class="btn-primary"
          (click)="generateShareLink()"
          [disabled]="isLoadingShare"
        >
          {{ isLoadingShare ? 'Creating link…' : 'Create share link' }}
        </button>
      </div>
    </ng-template>
  </section>
</div>

<!-- Photo viewer modal (lightbox) -->
<div
  class="photo-viewer-backdrop"
  *ngIf="isPhotoViewerOpen"
  (click)="closePhotoViewer()"
></div>

<div
  class="photo-viewer-modal"
  *ngIf="isPhotoViewerOpen"
  (click)="$event.stopPropagation()"
>
  <button
    type="button"
    class="photo-viewer-close"
    (click)="closePhotoViewer()"
  >
    ✕
  </button>

  <div
    *ngIf="currentViewerPhoto as photo"
    class="photo-viewer-body"
  >
    <button
      type="button"
      class="viewer-nav viewer-nav-prev"
      (click)="$event.stopPropagation(); prevViewerPhoto()"
    >
      ‹
    </button>

    <div class="photo-viewer-image-wrapper">
      <img
        [src]="imageBaseUrl + photo.originalUrl"
        [alt]="selectedEventId ? selectedEventName : 'Album photo'"
        class="photo-viewer-image"
      />

      <p class="photo-viewer-caption">
        Photo {{ viewerIndex + 1 }} of {{ viewerPhotos.length }}
        <span *ngIf="selectedEventId">
          • {{ selectedEventName }}
        </span>
        <span *ngIf="photo.takenAt || photo.uploadedAt">
          •
          <ng-container *ngIf="photo.takenAt; else uploadedDateViewer">
            {{ photo.takenAt | date: 'short' }}
          </ng-container>
          <ng-template #uploadedDateViewer>
            Uploaded at: {{ photo.uploadedAt | date: 'short' }}
          </ng-template>
        </span>
      </p>
    </div>

    <button
      type="button"
      class="viewer-nav viewer-nav-next"
      (click)="$event.stopPropagation(); nextViewerPhoto()"
    >
      ›
    </button>

    <div class="photo-viewer-hint">
      ← → to navigate • Esc to close
    </div>
  </div>
</div>

<!-- Fallback loading state -->
<div *ngIf="!album && !errorMessage" class="loading">
  Loading album details...
</div>
